<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Color Prediction Game</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 30px; background: #f9f9f9; }
    input, button, select { margin: 8px; padding: 10px; font-size: 16px; }
    .hidden { display: none; }
    .button { padding: 12px 25px; margin: 10px; font-size: 16px; cursor: pointer; border-radius: 8px; }
    .green { background: forestgreen; color: white; }
    .red { background: crimson; color: white; }
    .violet { background: purple; color: white; }
    .menu-bar { position: absolute; top: 10px; right: 20px; }
    #timer { font-weight: bold; color: red; margin-top: 10px; font-size: 20px; }
    table { margin: 20px auto; border-collapse: collapse; width: 90%; max-width: 500px; }
    th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h2>üéØ Color Prediction Game</h2>

  <div class="menu-bar">
    <select id="menu" onchange="handleMenu()">
      <option value="game">üéÆ Play Game</option>
      <option value="wallet">üí∞ Wallet</option>
      <option value="account">üë§ Account</option>
    </select>
  </div>

  <div id="login">
    <input type="text" id="usernameInput" placeholder="Enter your name"><br />
    <select id="testNumbers">
      <option value="">-- Select Test Number --</option>
      <option value="+919999999999">+91 99999 99999 (OTP: 123456)</option>
      <option value="+919888888888">+91 98888 88888 (OTP: 111111)</option>
      <option value="+917777777777">+91 77777 77777 (OTP: 222222)</option>
    </select><br />
    <input type="text" id="phone" placeholder="Enter phone +91...">
    <button onclick="sendOTP()">Send OTP</button><br />
    <input type="text" id="otp" placeholder="Enter OTP">
    <button onclick="verifyOTP()">Verify OTP</button>
    <div id="recaptcha-container"></div>
  </div>

  <div id="game" class="hidden">
    <p>üë§ Welcome <span id="username"></span> | üìû <span id="userphone"></span></p>
    <div id="accountSection" class="hidden">
      <h3>Account Details</h3>
      <p>Name: <span id="displayName"></span></p>
      <p>Phone: <span id="displayPhone"></span></p>
    </div>

    <div id="walletSection" class="hidden">
      <h3>Wallet Balance: ‚Çπ<span id="wallet">0</span></h3>
      <input type="number" id="topup" placeholder="Amount to Add">
      <button onclick="addMoney()">Add Money</button>
    </div>

    <div id="gameSection">
      <h4>Choose a color (min ‚Çπ30 required)</h4>
      <div>
        <button class="button green" onclick="placeBet('Green')">Green</button>
        <button class="button violet" onclick="placeBet('Violet')">Violet</button>
        <button class="button red" onclick="placeBet('Red')">Red</button>
      </div>
      <p id="status"></p>
      <p id="timer">‚úÖ You can place your next bet now</p>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Your Choice</th>
            <th>System Choice</th>
            <th>Profit/Loss</th>
            <th>Wallet</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
    <button onclick="logout()">Logout</button>

    <audio id="beepSound">
      <source src="https://www.soundjay.com/buttons/beep-07.mp3" type="audio/mpeg">
    </audio>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAnA3CY0FHyjli9oyEaFRp7Wp__5Z9vObk",
      authDomain: "shubh251625.firebaseapp.com",
      projectId: "shubh251625",
      storageBucket: "shubh251625.firebasestorage.app",
      messagingSenderId: "541512766925",
      appId: "1:541512766925:web:eca74693e7626b8e496084"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let userRef, user, userName, betLock = false;
    const history = [];

    function sendOTP() {
      const selectedNumber = document.getElementById("testNumbers").value;
      const phoneInput = document.getElementById("phone");
      if (selectedNumber) phoneInput.value = selectedNumber;
      userName = document.getElementById("usernameInput").value;
      if (!userName || !phoneInput.value) return alert("Enter your name and phone number");

      const phone = phoneInput.value;

      if (!window.recaptchaVerifier) {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          size: 'normal',
          callback: () => {},
          'expired-callback': () => alert("reCAPTCHA expired. Try again.")
        });
        window.recaptchaVerifier.render();
      }

      const appVerifier = window.recaptchaVerifier;
      auth.signInWithPhoneNumber(phone, appVerifier)
        .then(confirm => {
          window.confirmationResult = confirm;
          alert("OTP sent!");
        })
        .catch(error => alert("Error: " + error.message));
    }

    function verifyOTP() {
      const code = document.getElementById("otp").value;
      window.confirmationResult.confirm(code).then(handleLogin);
    }

    function handleLogin(result) {
      user = result.user;
      document.getElementById("login").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");

      document.getElementById("username").innerText = userName;
      document.getElementById("userphone").innerText = user.phoneNumber;
      document.getElementById("displayName").innerText = userName;
      document.getElementById("displayPhone").innerText = user.phoneNumber;

      userRef = db.collection("users").doc(user.uid);
      userRef.get().then(doc => {
        if (!doc.exists) return userRef.set({ name: userName, phone: user.phoneNumber, balance: 100 });
      }).then(() => userRef.get()).then(doc => {
        document.getElementById("wallet").innerText = doc.data().balance;
      });
    }

    function addMoney() {
      const amt = parseInt(document.getElementById("topup").value);
      if (amt > 0) {
        userRef.update({ balance: firebase.firestore.FieldValue.increment(amt) }).then(() => {
          alert("‚Çπ" + amt + " added");
          return userRef.get();
        }).then(doc => {
          document.getElementById("wallet").innerText = doc.data().balance;
        });
      }
    }

    function placeBet(choice) {
      if (betLock) return alert("‚è≥ Wait for next bet.");
      userRef.get().then(doc => {
        let balance = doc.data().balance;
        if (balance < 30) {
          document.getElementById("status").innerText = "‚ùå Minimum ‚Çπ30 needed.";
          return;
        }

        betLock = true;
        let timeLeft = 10;
        document.getElementById("timer").innerText = `‚è≥ Next bet available in ${timeLeft}s`;
        const timerInterval = setInterval(() => {
          timeLeft--;
          document.getElementById("timer").innerText = `‚è≥ Next bet available in ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            betLock = false;
            document.getElementById("timer").innerText = "‚úÖ You can place your next bet now";
            document.getElementById("beepSound").play();
          }
        }, 1000);

        const colorOptions = ['Red', 'Green', 'Violet'];
        const systemChoice = colorOptions[Math.floor(Math.random() * colorOptions.length)];
        let result = "LOST", winAmount = 0;

        if (choice === 'Green' && ['Green'].includes(systemChoice)) {
          result = "WON 2X"; winAmount = 20;
        } else if (choice === 'Red' && ['Red'].includes(systemChoice)) {
          result = "WON 2X"; winAmount = 20;
        } else if (choice === 'Violet' && ['Violet'].includes(systemChoice)) {
          result = "WON 4X"; winAmount = 40;
        } else {
          winAmount = -10;
        }

        const newBalance = balance + winAmount;
        userRef.update({ balance: newBalance });
        db.collection("users").doc(user.uid).collection("transactions").add({
          type: "BET", choice, systemChoice, result, amount: winAmount, time: new Date()
        });

        document.getElementById("wallet").innerText = newBalance;
        document.getElementById("status").innerText = `You chose ${choice}, System chose ${systemChoice} ‚Üí ${result}`;

        // Update history
        history.unshift({ choice, systemChoice, result, winAmount, balance: newBalance });
        if (history.length > 5) history.pop();
        updateHistoryTable();
      });
    }

    function updateHistoryTable() {
      const tbody = document.getElementById("historyBody");
      tbody.innerHTML = "";
      history.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.choice}</td>
          <td>${row.systemChoice}</td>
          <td>${row.winAmount >= 0 ? "+‚Çπ" + row.winAmount : "-‚Çπ" + Math.abs(row.winAmount)}</td>
          <td>‚Çπ${row.balance}</td>`;
        tbody.appendChild(tr);
      });
    }

    function logout() {
      auth.signOut();
      location.reload();
    }

    function handleMenu() {
      const section = document.getElementById("menu").value;
      document.getElementById("gameSection").style.display = section === "game" ? "block" : "none";
      document.getElementById("walletSection").style.display = section === "wallet" ? "block" : "none";
      document.getElementById("accountSection").style.display = section === "account" ? "block" : "none";
    }
  </script>
</body>
</html>