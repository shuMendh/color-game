<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Color Prediction Game</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 30px; background: #f9f9f9; }
    input, button, select { margin: 8px; padding: 10px; font-size: 16px; }
    .hidden { display: none; }
    .button { padding: 12px 25px; margin: 10px; font-size: 16px; cursor: pointer; border-radius: 8px; }
    .green { background: forestgreen; color: white; }
    .red { background: crimson; color: white; }
    .violet { background: purple; color: white; }
    .menu-bar { position: absolute; top: 10px; right: 20px; }
    #timer { font-weight: bold; color: red; margin-top: 10px; font-size: 20px; }
    table { margin: 20px auto; border-collapse: collapse; width: 90%; max-width: 500px; }
    th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h2>🎯 Color Prediction Game</h2>

  <div class="menu-bar">
    <select id="menu" onchange="handleMenu()">
      <option value="game">🎮 Play Game</option>
      <option value="wallet">💰 Wallet</option>
      <option value="account">👤 Account</option>
    </select>
  </div>

  <div id="login">
    <input type="text" id="usernameInput" placeholder="Enter your name"><br />
    <select id="testNumbers">
      <option value="">-- Select Test Number --</option>
      <option value="+919999999999">+91 99999 99999 (OTP: 123456)</option>
    </select><br />
    <input type="text" id="phone" placeholder="Enter phone +91...">
    <button onclick="sendOTP()">Send OTP</button><br />
    <input type="text" id="otp" placeholder="Enter OTP">
    <button onclick="verifyOTP()">Verify OTP</button>
    <div id="recaptcha-container"></div>
  </div>

  <div id="game" class="hidden">
    <p>👤 Welcome <span id="username"></span> | 📞 <span id="userphone"></span></p>

    <div id="walletSection" class="hidden">
      <h3>Wallet Balance: ₹<span id="wallet">0</span></h3>
      <input type="number" id="topup" placeholder="Amount to Add">
      <button onclick="addMoney()">Add Money</button>
    </div>

    <div id="gameSection">
      <h4>Choose a color (min ₹30 required)</h4>
      <div>
        <button class="button green" onclick="placeBet('Green')">Green</button>
        <button class="button violet" onclick="placeBet('Violet')">Violet</button>
        <button class="button red" onclick="placeBet('Red')">Red</button>
      </div>
      <p id="status"></p>
      <p id="timer">✅ You can place your next bet now</p>

      <table id="historyTable">
        <thead>
          <tr>
            <th>Your Choice</th>
            <th>System Choice</th>
            <th>Profit/Loss</th>
            <th>Wallet</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>

    <button onclick="logout()">Logout</button>
    <audio id="beepSound">
      <source src="https://www.soundjay.com/buttons/beep-07.mp3" type="audio/mpeg">
    </audio>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAnA3CY0FHyjli9oyEaFRp7Wp__5Z9vObk",
      authDomain: "shubh251625.firebaseapp.com",
      projectId: "shubh251625",
      storageBucket: "shubh251625.appspot.com",
      messagingSenderId: "541512766925",
      appId: "1:541512766925:web:eca74693e7626b8e496084"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let userRef, user, userName, betLock = false;
    const history = [];

    function sendOTP() {
      const phoneInput = document.getElementById("phone");
      const selected = document.getElementById("testNumbers").value;
      if (selected) phoneInput.value = selected;
      userName = document.getElementById("usernameInput").value;
      if (!userName || !phoneInput.value) return alert("Enter name and phone");
      if (!window.recaptchaVerifier) {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container');
        window.recaptchaVerifier.render();
      }
      auth.signInWithPhoneNumber(phoneInput.value, window.recaptchaVerifier)
        .then(confirm => window.confirmationResult = confirm)
        .then(() => alert("OTP Sent"));
    }

    function verifyOTP() {
      const code = document.getElementById("otp").value;
      window.confirmationResult.confirm(code).then(handleLogin);
    }

    function handleLogin(result) {
      user = result.user;
      document.getElementById("login").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      document.getElementById("username").innerText = userName;
      document.getElementById("userphone").innerText = user.phoneNumber;
      userRef = db.collection("users").doc(user.uid);
      userRef.get().then(doc => {
        if (!doc.exists) return userRef.set({ name: userName, phone: user.phoneNumber, balance: 100 });
      }).then(() => userRef.get()).then(doc => {
        document.getElementById("wallet").innerText = doc.data().balance;
      });
    }

    function addMoney() {
      const amt = parseInt(document.getElementById("topup").value);
      if (amt > 0) {
        userRef.update({ balance: firebase.firestore.FieldValue.increment(amt) }).then(() => {
          return userRef.get();
        }).then(doc => {
          document.getElementById("wallet").innerText = doc.data().balance;
        });
      }
    }

    function placeBet(selectedColor) {
      if (betLock) return alert("⏳ Wait for next bet");
      userRef.get().then(doc => {
        const balance = doc.data().balance;
        if (balance < 30) {
          document.getElementById("status").innerText = "❌ Minimum ₹30 required.";
          return;
        }

        betLock = true;
        let timeLeft = 10;
        document.getElementById("timer").innerText = `⏳ Next bet in ${timeLeft}s`;
        const interval = setInterval(() => {
          timeLeft--;
          document.getElementById("timer").innerText = `⏳ Next bet in ${timeLeft}s`;
          if (timeLeft === 0) {
            clearInterval(interval);
            betLock = false;
            document.getElementById("timer").innerText = "✅ You can place your next bet now";
            document.getElementById("beepSound").play();
          }
        }, 1000);

        const colorOptions = ['Red', 'Green', 'Violet'];
        const systemChoice = colorOptions[Math.floor(Math.random() * colorOptions.length)];
        let result = "LOST", winAmount = -10;

        if (selectedColor === systemChoice) {
          result = selectedColor === 'Violet' ? "WON 4X" : "WON 2X";
          winAmount = selectedColor === 'Violet' ? 40 : 20;
        }

        const newBalance = balance + winAmount;
        userRef.update({ balance: newBalance });
        db.collection("users").doc(user.uid).collection("transactions").add({
          type: "BET", choice: selectedColor, systemChoice, result, amount: winAmount, time: new Date()
        });

        document.getElementById("wallet").innerText = newBalance;
        document.getElementById("status").innerText = `🎯 You chose: ${selectedColor}, System chose: ${systemChoice} → ${result}`;
        history.unshift({ choice: selectedColor, systemChoice, result, winAmount, balance: newBalance });
        if (history.length > 5) history.pop();
        updateHistoryTable();
      });
    }

    function updateHistoryTable() {
      const tbody = document.getElementById("historyBody");
      tbody.innerHTML = "";
      history.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.choice}</td>
          <td>${row.systemChoice}</td>
          <td>${row.winAmount >= 0 ? "+₹" + row.winAmount : "-₹" + Math.abs(row.winAmount)}</td>
          <td>₹${row.balance}</td>`;
        tbody.appendChild(tr);
      });
    }

    function logout() {
      auth.signOut().then(() => location.reload());
    }

    function handleMenu() {
      document.getElementById("walletSection").style.display = (menu.value === "wallet") ? "block" : "none";
      document.getElementById("gameSection").style.display = (menu.value === "game") ? "block" : "none";
    }
  </script>
</body>
</html>