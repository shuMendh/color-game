<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Color Prediction Game</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 30px; background: #f9f9f9; }
    input, button { margin: 8px; padding: 10px; font-size: 16px; }
    .hidden { display: none; }
    .button { padding: 12px 25px; margin: 10px; font-size: 16px; cursor: pointer; border-radius: 8px; }
    .green { background: forestgreen; color: white; }
    .red { background: crimson; color: white; }
    .violet { background: purple; color: white; }
    .number-btn { width: 60px; height: 60px; margin: 5px; font-size: 20px; }
  </style>
</head>
<body>
  <h2>ðŸŽ¯ Color Prediction Game</h2>
  <div id="login">
    <button onclick="loginWithGoogle()">Login with Google</button><br />
    <input type="text" id="phone" placeholder="Enter phone +91...">
    <button onclick="sendOTP()">Send OTP</button><br />
    <input type="text" id="otp" placeholder="Enter OTP">
    <button onclick="verifyOTP()">Verify OTP</button>
    <div id="recaptcha-container"></div>
  </div>

  <div id="game" class="hidden">
    <p>ðŸ‘¤ Welcome <span id="username"></span> | ðŸ“ž <span id="userphone"></span></p>
    <h3>Wallet Balance: â‚¹<span id="wallet">0</span></h3>
    <input type="number" id="topup" placeholder="Amount to Add">
    <button onclick="addMoney()">Add Money</button>
    <h4>Choose a color or number (min â‚¹30 required)</h4>
    <div>
      <button class="button green" onclick="placeBet('Green')">Green</button>
      <button class="button violet" onclick="placeBet('Violet')">Violet</button>
      <button class="button red" onclick="placeBet('Red')">Red</button>
    </div>
    <div>
      <button class="number-btn" onclick="placeBet(0)">0</button>
      <button class="number-btn" onclick="placeBet(1)">1</button>
      <button class="number-btn" onclick="placeBet(2)">2</button>
      <button class="number-btn" onclick="placeBet(3)">3</button>
      <button class="number-btn" onclick="placeBet(4)">4</button>
      <button class="number-btn" onclick="placeBet(5)">5</button>
      <button class="number-btn" onclick="placeBet(6)">6</button>
      <button class="number-btn" onclick="placeBet(7)">7</button>
      <button class="number-btn" onclick="placeBet(8)">8</button>
      <button class="number-btn" onclick="placeBet(9)">9</button>
    </div>
    <p id="status"></p>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAnA3CY0FHyjli9oyEaFRp7Wp__5Z9vObk",
      authDomain: "shubh251625.firebaseapp.com",
      projectId: "shubh251625",
      storageBucket: "shubh251625.firebasestorage.app",
      messagingSenderId: "541512766925",
      appId: "1:541512766925:web:eca74693e7626b8e496084"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let userRef, user;

    function loginWithGoogle() {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(handleLogin);
    }

    function sendOTP() {
      const phone = document.getElementById("phone").value;

      if (!window.recaptchaVerifier) {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          size: 'normal',
          callback: (response) => {},
          'expired-callback': () => { alert("reCAPTCHA expired. Try again."); }
        });
        window.recaptchaVerifier.render();
      }

      const appVerifier = window.recaptchaVerifier;

      auth.signInWithPhoneNumber(phone, appVerifier)
        .then(confirmationResult => {
          window.confirmationResult = confirmationResult;
          alert("OTP sent!");
        })
        .catch(error => {
          alert("Error sending OTP: " + error.message);
        });
    }

    function verifyOTP() {
      const code = document.getElementById("otp").value;
      window.confirmationResult.confirm(code).then(handleLogin);
    }

    function handleLogin(result) {
      user = result.user;
      document.getElementById("login").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      document.getElementById("username").innerText = user.displayName || "Phone User";
      document.getElementById("userphone").innerText = user.phoneNumber || user.email;
      userRef = db.collection("users").doc(user.uid);
      userRef.get().then(doc => {
        if (!doc.exists) return userRef.set({ balance: 100 });
      }).then(() => {
        return userRef.get();
      }).then(doc => {
        document.getElementById("wallet").innerText = doc.data().balance;
      });
    }

    function addMoney() {
      const amt = parseInt(document.getElementById("topup").value);
      if (amt > 0) {
        userRef.update({ balance: firebase.firestore.FieldValue.increment(amt) }).then(() => {
          alert("â‚¹" + amt + " added");
          return userRef.get();
        }).then(doc => {
          document.getElementById("wallet").innerText = doc.data().balance;
        });
      }
    }

    function placeBet(choice) {
      userRef.get().then(doc => {
        let balance = doc.data().balance;
        if (balance < 30) {
          document.getElementById("status").innerText = "âŒ Minimum â‚¹30 needed.";
          return;
        }
        const number = Math.floor(Math.random() * 10);
        let result = "LOST", winAmount = 0;

        if (typeof choice === 'number' && choice === number) {
          result = "WON 8X"; winAmount = 80;
        } else if (choice === 'Green' && [1,3,7,9].includes(number)) {
          result = "WON 2X"; winAmount = 20;
        } else if (choice === 'Red' && [2,4,6,8].includes(number)) {
          result = "WON 2X"; winAmount = 20;
        } else if (choice === 'Violet' && [0,5].includes(number)) {
          result = "WON 4X"; winAmount = 40;
        } else {
          winAmount = -10;
        }

        userRef.update({ balance: firebase.firestore.FieldValue.increment(winAmount) });
        db.collection("users").doc(user.uid).collection("transactions").add({
          type: "BET", choice, number, result, amount: winAmount, time: new Date()
        });
        document.getElementById("wallet").innerText = balance + winAmount;
        document.getElementById("status").innerText = `ðŸŽ¯ Draw: ${number}, ${result} | Wallet: â‚¹${balance + winAmount}`;
      });
    }

    function logout() {
      auth.signOut();
      location.reload();
    }
  </script>
</body>
</html>